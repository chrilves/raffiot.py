<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Resource Management - RAFFIOT Guide</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="raffiot.html"><strong aria-hidden="true">1.</strong> Robust and Fast Functional IO Toolkit</a></li><li class="chapter-item expanded "><a href="first_steps.html"><strong aria-hidden="true">2.</strong> First Steps with IO</a></li><li class="chapter-item expanded "><a href="failures.html"><strong aria-hidden="true">3.</strong> Failures</a></li><li class="chapter-item expanded "><a href="context.html"><strong aria-hidden="true">4.</strong> Context</a></li><li class="chapter-item expanded "><a href="lists.html"><strong aria-hidden="true">5.</strong> Combining a list of IOs</a></li><li class="chapter-item expanded "><a href="async.html"><strong aria-hidden="true">6.</strong> Asynchronous Computing</a></li><li class="chapter-item expanded "><a href="resource.html" class="active"><strong aria-hidden="true">7.</strong> Resource Management</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">RAFFIOT Guide</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="resource-management"><a class="header" href="#resource-management">Resource Management</a></h1>
<p>Resource management is the safe creation and release
of resources: files, connection handlers, etc. Resource
management ensures all created resources will be released
this avoiding resource leaks.</p>
<p>Consider the code below accessing a database:</p>
<pre><code class="language-python">&gt;&gt;&gt; connection = connect_to_database()
&gt;&gt;&gt; connection.exectute_sql_query(...)
&gt;&gt;&gt; connection.close()
</code></pre>
<p>If the execution of the SQL query raise an exception, the
connection is never closed. Having too many unused connection
opened may forbid other parts of the code from creating new
connections, or may slow down the database or even crash
the application.</p>
<p>Fortunately Python has a built-in support for resource management
with the <code>with</code> syntax:</p>
<pre><code class="language-python">&gt;&gt;&gt; with connect_to_database() as connection:
...   connection.exectute_sql_query(...)
</code></pre>
<p>Sometimes the resource you want to create depends on another resource.
For example the connection configuration to the database could be
stored in a configuration file that need to be opened and closed:</p>
<pre><code class="language-python">&gt;&gt;&gt; with open_config_file() as file_content:
...   config = read_config(file_content)
...   with connect_to_database(config) as connection:
...     connection.exectute_sql_query(...)
</code></pre>
<p>Once again Python's <code>with</code>-statement covers this case nicely.
But there are two issues with Python's built-in resource management:</p>
<ol>
<li>it is not trivial to pack two dependent resources into one.</li>
<li>it is not trivial to create your own resources.</li>
</ol>
<p>This is where <em>Raffiot</em>'s resource management comes in.
Creating a <code>Resource</code> is as simple as providing a function to create
the resource and one to release it. You can also lift any Python's
&quot;<code>with</code>-enabled&quot; resource to <em>Raffiot</em>'s <code>Resource</code> by a single
function call.</p>
<p><code>Resource</code> do compose very well too with the same API as <code>IO</code>.
In fact <code>Resource</code> is built upon <code>IO</code>. It has almost all of its
functionalities. Here are the imports for this section:</p>
<pre><code class="language-python">&gt;&gt;&gt; from raffiot import resource, io
&gt;&gt;&gt; from raffiot.resource import Resource
&gt;&gt;&gt; from raffiot.io import IO
&gt;&gt;&gt; from typing import Tuple, List, Any
</code></pre>
<p>Let's start by defining an <code>IO</code> that generates a random string
every time it runs:</p>
<pre><code class="language-python">&gt;&gt;&gt; import random
&gt;&gt;&gt; import string
&gt;&gt;&gt; rnd_str : IO[None, None, str] = (
...   io.defer(lambda:
...     ''.join(
...       random.choice(string.ascii_uppercase + string.digits)
...      for _ in range(8)
...     )
...   )
... )
&gt;&gt;&gt; rnd_str.run(None)
Ok(success='CCQN80YY')
&gt;&gt;&gt; rnd_str.run(None)
Ok(success='5JEOGVZS')
&gt;&gt;&gt; rnd_str.run(None)
Ok(success='ZNLWSH1B')
&gt;&gt;&gt; rnd_str.run(None)
Ok(success='MENS91RD')
</code></pre>
<h2 id="from_open_close_io--creating-a-resource-from-openclose-ios"><a class="header" href="#from_open_close_io--creating-a-resource-from-openclose-ios"><code>from_open_close_io</code> : Creating a <code>Resource</code> from open/close <code>IO</code>s</a></h2>
<p>The <code>Resource</code> we want to define will create and print a new string
every time it is used. Releasing it will simply be printing it.
A <code>Resource</code> is essentially two computations:</p>
<ul>
<li>one creating the resource</li>
<li>one releasing the resource</li>
</ul>
<p>Let's start by the <code>IO</code> creating and printing the string:</p>
<pre><code class="language-python">&gt;&gt;&gt; rs_open : IO[None, None, str] = (
...   rnd_str.flat_map(lambda s: io.sequence(
...     io.defer(print, f&quot;Opening {s}&quot;),
...     io.pure(s)
...   ))
... )
</code></pre>
<p>Now the function releasing the string (i.e. printing it):</p>
<pre><code class="language-python">&gt;&gt;&gt; def rs_close(s: str) -&gt; IO[None, None, None]:
...   return io.defer(print, f&quot;Closing {s}&quot;)
</code></pre>
<p>From there, creating a <code>Resource</code> is as simple as a single call
to <code>resource.from_open_close_io</code>:</p>
<pre><code class="language-python">&gt;&gt;&gt; rs : Resource[None,None,str] = resource.from_open_close_io(rs_open, rs_close)
</code></pre>
<p>That wasn't that hard, isn't it?</p>
<h2 id="use--using-a-resource"><a class="header" href="#use--using-a-resource"><code>use</code> : using a resource</a></h2>
<p>Now that we have a <code>Resource</code>, we want to use it. To do so, just
call the method <code>use</code>. You need to give it a function taking as
argument the resource created and retuning an <code>IO</code> that used this
resource. The result is an <code>IO</code>:</p>
<pre><code class="language-python">&gt;&gt;&gt; io_ok : IO[None,None,int] = rs.use(lambda s: io.pure(5))
&gt;&gt;&gt; io_ok.run(None)
Opening B9G0G96J
Closing B9G0G96J
Ok(success=5)
</code></pre>
<p>As you can see a random string is created and released.
The result is an <code>IO</code> whose result is the result of the inner <code>IO</code>.</p>
<pre><code class="language-python">&gt;&gt;&gt; io_error : IO[None,None,Any] = rs.use(lambda s: io.error(&quot;Oups!&quot;))
&gt;&gt;&gt; io_error.run(None)
Opening R9A1YSJ3
Closing R9A1YSJ3
Error(error='Oups!')
</code></pre>
<p>If the inner <code>IO</code> fails, the string is still released!</p>
<pre><code class="language-python">&gt;&gt;&gt; io_panic : IO[None,None,None] = rs.use(lambda s: io.panic(Exception(&quot;BOOM!&quot;)))
&gt;&gt;&gt; io_panic.run(None)
Opening PSUNW6M5
Closing PSUNW6M5
Panic(exception=Exception('BOOM!'))
</code></pre>
<p>If the inner <code>IO</code> panics, the string is still released too!</p>
<h2 id="map-flat_map-defer-async_-and-others"><a class="header" href="#map-flat_map-defer-async_-and-others"><code>map</code>, <code>flat_map</code>, <code>defer</code>, <code>async_</code> and others.</a></h2>
<p><code>Resource</code> supports almost the same API as <code>IO</code>.
It includes <code>map</code>, <code>flat_map</code>, <code>defer</code>, <code>zip</code>, etc.
It means, for example, that you can create resources in parallel,
or simply create a list of resources (if one fails, all fails),
etc.</p>
<h2 id="lift_io--from-io-to-resource"><a class="header" href="#lift_io--from-io-to-resource"><code>lift_io</code> : from <code>IO</code> to <code>Resource</code></a></h2>
<p>Actually, any <code>IO[E,E,A]</code> can be lifted into a <code>Resource[R,E,A]</code>.
The releasing function is just a no-op. It brings a lot of expressiveness
and safety to resource creation:</p>
<pre><code class="language-python">&gt;&gt;&gt; rs : Resource[None,None,None] = resource.lift_io(io.defer(print, &quot;Hello World!&quot;))
&gt;&gt;&gt; rs.use(lambda none: io.pure(5)).run(None)
Hello World!
Ok(success=5)
</code></pre>
<h2 id="from_open_close--resource-from-open-and-close-functions"><a class="header" href="#from_open_close--resource-from-open-and-close-functions"><code>from_open_close</code> : Resource from open and close functions</a></h2>
<p>Sometimes it is easier to create a <code>Resource</code> from usual Python's
functions rather than from the open/close <code>IO</code>s. To do so, just
use the function <code>resource.from_open_close</code>:</p>
<pre><code class="language-python">&gt;&gt;&gt; def rs_open() -&gt; str:
...   s = ''.join(
...     random.choice(string.ascii_uppercase + string.digits)
...     for _ in range(8)
...   )
...   print(f&quot;Opening {s}&quot;)
...   return s
&gt;&gt;&gt; def rs_close(s: str) -&gt; None:
...   print(f&quot;Closing {s}&quot;)
&gt;&gt;&gt; rs : Resource[None,None,str] = resource.from_open_close(rs_open, rs_close)
</code></pre>
<h2 id="from_with--resource-from-with"><a class="header" href="#from_with--resource-from-with"><code>from_with</code> : Resource from <code>with</code></a></h2>
<p>If the resource you want to create already support Python's
<code>with</code>-statement, then you're lucky: you just have to make
one single call to <code>resource.from_with</code></p>
<pre><code class="language-python">&gt;&gt;&gt; rs : Resource[None,None,str] = resource.from_with(io.defer(open, &quot;hello.txt&quot;, &quot;w&quot;))
</code></pre>
<h2 id="creating-a-resource-directly"><a class="header" href="#creating-a-resource-directly">Creating a Resource directly</a></h2>
<p>A <code>Resource[R,E,A]</code> is essentially an <code>IO[R,E,Tuple[A, IO[R,Any,Any]]]</code>.
When the <code>IO</code> runs, it returns a pair <code>Tuple[A, IO[R,Any,Any]]</code>.
The fist member of the pair is the created resource of type <code>A</code>.
The second member of the pair is the <code>IO</code> to run to release the
resource.
Note that the result and failures of the releasing <code>IO</code> are ignored.</p>
<pre><code class="language-python">&gt;&gt;&gt; create : IO[None,None,Tuple[str, IO[None,Any,Any]]] = (
...   rnd_str.flat_map(lambda filename:
...     io.defer(print, f&quot;Opening {filename}&quot;).map(lambda file:
...       (file, io.defer(print, f&quot;Closing {filename}&quot;))
...     )
...   )
... )
&gt;&gt;&gt; rs : Resource[None,None,str] = Resource(create)
</code></pre>
<h2 id="use-case--temporary-file"><a class="header" href="#use-case--temporary-file">Use Case : Temporary File</a></h2>
<p>This is a complete use case of a <code>Resource</code> creating a random file.</p>
<pre><code class="language-python">&gt;&gt;&gt; from io import TextIOWrapper
&gt;&gt;&gt; create : IO[None,None,Tuple[TextIOWrapper, IO[None,None,None]]] = (
...   rnd_str
...   .flat_map(lambda filename:
...     io.defer(print, f&quot;Opening {filename}&quot;)
...     .then(io.defer(open, filename, &quot;w&quot;))
...     .map(lambda file:
...       ( file,
...         io.defer(print, f&quot;Closing {filename}&quot;)
...         .then(io.defer(f.close))
...       )
...     )
...    )
... )
&gt;&gt;&gt; rs : Resource[None,None,TextIOWrapper] = Resource(create)
&gt;&gt;&gt; io_ok : IO[None,None,None] = (
...   rs.use(lambda file:
...     io.defer(file.write, &quot;Hello World!&quot;)
...   )
... )
&gt;&gt;&gt; io_ok.run(None)
&gt;&gt;&gt; io_error : IO[None,None,None] = (
...   rs.use(lambda file:
...     io.defer(file.write, &quot;Hello World!&quot;)
...     .then(io.error(&quot;Oups!&quot;))
...   )
... )
&gt;&gt;&gt; io_error.run(None)
Opening R9A1YSJ3
Closing R9A1YSJ3
Error(error='Oups!')
&gt;&gt;&gt; io_panic : IO[None,None,None] = (
...   rs.use(lambda file:
...     io.defer(file.write, &quot;Hello World!&quot;)
...     .then(io.panic(Exception(&quot;BOOM!&quot;)))
...   )
... )
&gt;&gt;&gt; io_panic.run(None)
Opening PSUNW6M5
Closing PSUNW6M5
Panic(exception=Exception('BOOM!'))
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="async.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="async.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
